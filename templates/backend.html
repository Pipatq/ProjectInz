<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Information & Billing System</title>
    <style>
        /* Base Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 {
            color: #2c3e50;
            margin-top: 0;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }

        /* --- Layout & Tabs --- */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            background-color: #ecf0f1;
        }
        
        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background-color: #e8eef1;
            color: #34495e;
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab {
            display: none;
            padding: 25px;
        }
        
        .tab.active {
            display: block;
        }
        
        /* --- Form & Input Styles --- */
        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ecf0f1;
        }
        .section:last-child {
            border-bottom: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"], 
        input[type="number"],
        select,
        textarea { /* Added textarea */
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Ensure consistent font */
        }
        
        input[type="text"]:focus, 
        input[type="number"]:focus,
        select:focus,
        textarea:focus { /* Added textarea */
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 20px;
            align-items: center;
            padding-top: 5px;
        }
        .checkbox-group label {
            font-weight: normal;
            margin-bottom: 0;
        }
        .checkbox-group input {
            margin-right: 5px;
        }
        
        /* --- Button Styles --- */
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }

        button.back, button.secondary {
            background-color: #95a5a6;
        }
        button.back:hover, button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        /* --- Product & Cart --- */
        #cart {
            margin-top: 20px;
            background-color: #f8f9f9;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background-color: #ecf0f1;
            font-weight: 600;
        }

        .quick-search-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-search-btn {
            background-color: #e6f2ff;
            color: #2c5282;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .quick-search-btn:hover { background-color: #d0e1ff; }

        .search-input-container {
            position: relative;
        }

        .clear-search {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            width: 40px;
            background: #fff;
            border: none;
            color: #a0aec0;
            font-size: 20px;
            cursor: pointer;
            border-radius: 0 6px 6px 0;
        }
        
        /* --- Billing Summary & Receipt --- */
        #billingSummary {
            margin-top: 20px;
            padding: 20px;
            background-color:#ecf5ff;
            border: 1px solid #b3d4fc;
            border-radius: 8px;
        }
        #billingSummary p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        #billingSummary strong {
            font-size: 1.1em;
            color: #2980b9;
        }
        #billingSummary hr {
            border: none;
            border-top: 1px solid #b3d4fc;
            margin: 10px 0;
        }

        .receipt-preview-container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
        }
        
        /* Hide parts of the on-screen receipt preview */
        #receipt_display [data-hide-on-screen="true"] {
            display: none;
        }

        .print-area {
            display: none;
        }


        /* Print Styles */
        @media print {
            @page {
                size: A5;
                margin: 10mm;
            }
            body { background-color: white; font-size: 9pt; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            
            /* --- General rule to hide everything by default when printing --- */
            body > *:not(.print-area) {
                display: none !important;
            }
            .print-area {
                display: block !important;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                width: 100%;
                height: auto;
            }
             
            /* --- Styles for Full A5 Receipt --- */
            .print-area#receipt {
                box-sizing: border-box;
            }
            .print-area#receipt h2 { font-size: 14pt; margin-bottom: 4px; }
            .print-area#receipt h3 { font-size: 11pt; margin-top: 8px; }
            .print-area#receipt h4 { font-size: 10pt; }
            .print-area#receipt p { line-height: 1.3; margin: 1px 0; font-size: 9pt; }
            .print-area#receipt table { font-size: 8pt; }
            .print-area#receipt th, .print-area#receipt td { padding: 3px 5px; }


            /* --- Styles for Deposit Slip (A6 size) --- */
            .print-area#depositSlip {
                width: 105mm;
                height: 148mm;
                padding: 5mm;
                box-sizing: border-box;
            }
            .print-area#depositSlip h2 { font-size: 14pt; }
            .print-area#depositSlip p { font-size: 12pt; margin: 10px 0; }
        }
    </style>
</head>
<body>

    <h1 class="no-print">Patient &amp; Billing System</h1>

    <div class="main-container no-print">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('patientTab')">1. Patient &amp; Billing</button>
            <button class="tab-button" onclick="openTab('productsTab')">2. Products</button>
            <button class="tab-button" onclick="openTab('receiptTab')">3. Receipt</button>
            <button class="tab-button" onclick="loadTransactionHistory(); openTab('historyTab')">History</button>
        </div>

        <!-- Tab 1: Patient & Billing Info -->
        <div id="patientTab" class="tab active">
            <div class="section">
                <h2>Patient & Procedure Information</h2>
                <div class="form-grid">
                    <div>
                        <label for="firstName">First Name:</label>
                        <input type="text" id="firstName" placeholder="ชื่อจริง" autofocus>
                    </div>
                    <div>
                        <label for="lastName">Last Name:</label>
                        <input type="text" id="lastName" placeholder="นามสกุล">
                    </div>
                    <div>
                        <label for="patientType">Patient Type:</label>
                        <select id="patientType">
                            <option value="OPD">OPD (Outpatient)</option>
                            <option value="IPD">IPD (Inpatient)</option>
                            <option value="ForeignOPD">Foreign OPD</option>
                            <option value="ForeignIPD">Foreign IPD</option>
                            <option value="Staff">Staff</option>
                        </select>
                    </div>
                    <div>
                        <label for="patientAge">Age (อายุ):</label>
                        <input type="number" id="patientAge" placeholder="ตัวอย่าง: 35">
                    </div>
                    <div>
                        <label for="doctorName">Doctor Name (ชื่อหมอ):</label>
                        <input type="text" id="doctorName" placeholder="ชื่อแพทย์ผู้ทำการรักษา">
                    </div>
                    <div>
                        <label for="consultant">Consultant (ผู้ให้คำปรึกษา):</label>
                        <input type="text" id="consultant" placeholder="ชื่อผู้ให้คำปรึกษา">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="procedureInfo">Procedure (หัตถการ):</label>
                        <input type="text" id="procedureInfo" placeholder="เช่น Full Blepharoplasty, Mini Blepharoplasty">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Billing & Payment</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Payment Details</h3>
                    <button class="secondary" onclick="printDepositSlip()">🖨️ Print Deposit Slip</button>
                </div>
                <div class="form-grid">
                     <div>
                        <label for="hospitalFee">Hospital Fee (ค่าโรงพยาบาล):</label>
                        <input type="number" id="hospitalFee" placeholder="0.00" value="0" oninput="updateBillingSummary()">
                    </div>
                    <div>
                        <label for="depositAmount">Deposit (มัดจำ):</label>
                        <input type="number" id="depositAmount" placeholder="0.00" value="0" oninput="updateBillingSummary()">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label>Payment Method (วิธีชำระเงิน):</label>
                        <div class="checkbox-group">
                            <input type="radio" id="payCash" name="paymentMethod" value="Cash" checked> <label for="payCash">เงินสด (Cash)</label>
                            <input type="radio" id="payTransfer" name="paymentMethod" value="Transfer"> <label for="payTransfer">เงินโอน (Transfer)</label>
                        </div>
                    </div>
                     <div style="grid-column: 1 / -1;">
                        <label>Review Status:</label>
                        <div class="checkbox-group">
                             <input type="checkbox" id="statusDeposit" name="reviewStatus" value="มัดจำ"> <label for="statusDeposit">มัดจำ</label>
                             <input type="checkbox" id="statusEye" name="reviewStatus" value="ทำตา"> <label for="statusEye">ทำตา</label>
                             <input type="checkbox" id="statusReview" name="reviewStatus" value="รีวิว"> <label for="statusReview">รีวิว</label>
                             <input type="checkbox" id="statusNoReview" name="reviewStatus" value="ไม่รีวิว"> <label for="statusNoReview">ไม่รีวิว</label>
                        </div>
                    </div>
                     <div style="grid-column: 1 / -1;"> <!-- New Comment Field -->
                        <label for="comment">Comment (หมายเหตุ):</label>
                        <textarea id="comment" rows="3" placeholder="เพิ่มหมายเหตุเพิ่มเติม..."></textarea>
                    </div>
                </div>
            </div>
            
            <div id="billingSummary">
                <h4>Billing Summary (Preview)</h4>
                <p><span>Product Total (ยอดรวมสินค้า):</span> <span id="summaryProductTotal">0.00 ฿</span></p>
                <p><span>+ Hospital Fee (ค่า รพ.):</span> <span id="summaryHospitalFee">0.00 ฿</span></p>
                <hr>
                <p><strong><span>Grand Total (ยอดรวมทั้งหมด):</span> <span id="summaryGrandTotal">0.00 ฿</span></strong></p>
                <p><span>- Deposit (มัดจำ):</span> <span id="summaryDeposit">0.00 ฿</span></p>
                <hr>
                <p><strong><span>Outstanding Balance (ค้างชำระ):</span> <span id="summaryOutstanding">0.00 ฿</span></strong></p>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button onclick="savePatientInfoAndProceed()">Save &amp; Continue →</button>
            </div>
        </div>

        <!-- Tab 2: Products -->
        <div id="productsTab" class="tab">
            <button class="back" onclick="openTab('patientTab')">← Back to Patient Info</button>
            <h2>Product Selection</h2>
             <div class="search-container" style="margin-top: 20px;">
                <div class="quick-search-buttons">
                    <button class="quick-search-btn" onclick="quickSearch('IV')">IV</button>
                    <button class="quick-search-btn" onclick="quickSearch('Syringe')">Syringe</button>
                    <button class="quick-search-btn" onclick="quickSearch('Gauze')">Gauze</button>
                    <button class="quick-search-btn" onclick="quickSearch('Alcohol')">Alcohol</button>
                    <button class="quick-search-btn" onclick="quickSearch('แพ็คเกจ')">แพ็คเกจ</button>
                </div>
                <div class="search-input-container">
                    <input type="text" id="searchProduct" placeholder="ค้นหาสินค้าด้วยชื่อ หรือรหัส..." oninput="searchProducts()" autocomplete="off">
                    <button class="clear-search" onclick="clearSearch()">×</button>
                </div>
                <div id="searchResults" style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto; margin-top: 5px;"></div>
            </div>

            <div id="cart">
                <h3>Shopping Cart</h3>
                <table id="cartTable">
                    <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th><th>Action</th></tr></thead>
                    <tbody id="cartItems"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Product Total:</strong></td>
                            <td id="cartTotal">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
             <div style="text-align: right; margin-top: 20px;">
                <button onclick="generateReceipt()">Generate Receipt →</button>
            </div>
        </div>
        
        <!-- Tab 3: Receipt -->
        <div id="receiptTab" class="tab">
            <button class="back no-print" onclick="openTab('productsTab')">← Back to Products</button>
            
            <div class="receipt-preview-container">
                <!-- This content is populated by JS -->
            </div>

            <div class="no-print" style="margin-top: 30px; text-align: right;">
                <button onclick="printMainReceipt()">🖨️ Print Full Receipt</button>
                <button class="back" onclick="resetFlow()">New Patient</button>
            </div>
        </div>

        <!-- Tab 4: History -->
        <div id="historyTab" class="tab">
             <h2>Transaction History</h2>
            <input type="text" id="historySearch" placeholder="Search by patient name, doctor, or date..." oninput="searchHistory()" style="width: 100%; margin-bottom: 20px;">
            <div id="historyResults"><p>Loading history...</p></div>
        </div>
    </div>

    <!-- Hidden Printable Templates -->
    <div id="receipt" class="print-area">
        <h2>ใบเสร็จรับเงิน / Receipt</h2>
        <hr>
        <p><strong>Receipt ID:</strong> <span data-field="receiptId"></span> | <strong>Date:</strong> <span data-field="receiptDate"></span></p>

        <div class="receipt-grid">
            <div>
                <h4>Patient Details</h4>
                <p><strong>Name:</strong> <span data-field="receiptName"></span></p>
                <p><strong>Age:</strong> <span data-field="receiptAge"></span></p>
                <p><strong>Type:</strong> <span data-field="receiptType"></span></p>
            </div>
            <div>
                <h4>Procedure Details</h4>
                <p><strong>Doctor:</strong> <span data-field="receiptDoctor"></span></p>
                <p><strong>Consultant:</strong> <span data-field="receiptConsultant"></span></p>
                <p><strong>Procedure:</strong> <span data-field="receiptProcedure"></span></p>
            </div>
        </div>

        <h3>Items &amp; Charges</h3>
        <table id="receiptItemsTable_print">
            <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th></tr></thead>
            <tbody></tbody>
        </table>

        <table class="receipt-summary-table">
            <tbody>
                <tr><td>Product Total:</td><td><span data-field="receiptSubtotal">0.00</span> ฿</td></tr>
                <tr><td>Hospital Fee:</td><td><span data-field="receiptHospitalFee">0.00</span> ฿</td></tr>
                <tr style="font-weight: bold; border-top: 1px solid #333; border-bottom: 1px solid #333;"><td>Grand Total:</td><td><span data-field="receiptGrandTotal">0.00</span> ฿</td></tr>
                <tr><td>Deposit Paid:</td><td><span data-field="receiptDeposit">0.00</span> ฿</td></tr>
                <tr style="font-weight: bold; font-size: 1.1em; color: #c0392b;"><td>Outstanding:</td><td><span data-field="receiptOutstanding">0.00</span> ฿</td></tr>
            </tbody>
        </table>
        <p><strong>Payment Method:</strong> <span data-field="receiptPaymentMethod"></span></p>
        <p><strong>Review Status:</strong> <span data-field="receiptReviewStatus"></span></p>
        <p><strong>Comment:</strong> <span data-field="comment"></span></p>
    </div>

    <div id="depositSlip" class="print-area">
        <!-- <h2>ใบรับเงินมัดจำ / Deposit Receipt</h2>
        <hr>
        <p><strong>Date:</strong> <span data-field="depositDate"></span></p>
        <p><strong>Patient Name:</strong> <span data-field="depositName"></span></p>
        <p><strong>Procedure:</strong> <span data-field="depositProcedure"></span></p>
        <br>
        <p style="font-size: 20px;"><strong>จำนวนเงินมัดจำ (Deposit Amount):</strong></p>
        <p style="font-size: 1.5em; text-align: center; border: 1px solid black; padding: 10px; margin-top: 10px;">
            <span data-field="depositAmount">0.00</span> ฿
        </p>
        <br><br>
        <p>.........................................</p>
        <p>ผู้รับเงิน (Receiver)</p> -->
    </div>


    <script>
        // --- GLOBAL STATE ---
        let productList = [];
        let shoppingCart = [];
        let currentPatientDetails = {};
        let transactionHistory = [];
        const ALL_HEADERS = [
            'id', 'fname', 'lname', 'date', 'type', 'products', 'total',
            'doctor_name', 'consultant', 'hospital_fee', 'deposit_amount',
            'outstanding_balance', 'payment_method', 'review_status',
            'procedure_info', 'patient_age', 'comment'
        ];
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
            await loadTransactionHistory();
            document.getElementById('firstName').focus();
        });

        async function loadProducts() {
            try {
                // Prevent browser caching of the CSV file
                const response = await fetch('/static/items.csv?t=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvData = await response.text();
                if (!csvData.trim()) {
                    productList = [];
                    return;
                }
                const rawList = parseCsv(csvData);
                
                // After parsing, map keys to ensure consistency. This handles if the header is 'name' or 'ชื่อ'.
                productList = rawList.map(p => ({
                    ...p,
                    name: p.name || p.ชื่อ 
                }));

                console.log("Products loaded:", productList.length);
                if(productList.length > 0 && !productList[0].name) {
                    console.warn("Product 'name' field could not be found. Check 'items.csv' header for 'name' or 'ชื่อ'.");
                }
            } catch (error) {
                console.error("Error loading products:", error);
                alert("Failed to load product data.");
            }
        }
        
        // --- UI & TAB NAVIGATION ---
        function openTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick*="'${tabId}'"]`).classList.add('active');
        }

        // --- PATIENT & BILLING LOGIC (TAB 1) ---
        function savePatientInfoAndProceed() {
            const firstName = document.getElementById('firstName').value.trim();
            if (!firstName) {
                alert("Please enter at least a first name.");
                return;
            }
            
            // Get all checked review statuses and join them with a comma
            const checkedStatuses = Array.from(document.querySelectorAll('input[name="reviewStatus"]:checked'))
                                         .map(cb => cb.value)
                                         .join(',');

            currentPatientDetails = {
                firstName: firstName,
                lastName: document.getElementById('lastName').value.trim(),
                type: document.getElementById('patientType').value,
                patientAge: document.getElementById('patientAge').value,
                doctorName: document.getElementById('doctorName').value.trim(),
                consultant: document.getElementById('consultant').value.trim(),
                procedureInfo: document.getElementById('procedureInfo').value.trim(),
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
                reviewStatus: checkedStatuses, // Use the comma-separated string
                comment: document.getElementById('comment').value.trim() 
            };
            openTab('productsTab');
        }

        function updateBillingSummary() {
            const productTotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const hospitalFee = parseFloat(document.getElementById('hospitalFee').value) || 0;
            const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;

            const grandTotal = productTotal + hospitalFee;
            const outstandingBalance = grandTotal - depositAmount;

            document.getElementById('summaryProductTotal').textContent = `${productTotal.toFixed(2)} ฿`;
            document.getElementById('summaryHospitalFee').textContent = `${hospitalFee.toFixed(2)} ฿`;
            document.getElementById('summaryGrandTotal').textContent = `${grandTotal.toFixed(2)} ฿`;
            document.getElementById('summaryDeposit').textContent = `${depositAmount.toFixed(2)} ฿`;
            document.getElementById('summaryOutstanding').textContent = `${outstandingBalance.toFixed(2)} ฿`;

            return { productTotal, hospitalFee, depositAmount, grandTotal, outstandingBalance };
        }

        // --- PRODUCT & CART LOGIC (TAB 2) ---
        function quickSearch(term) {
            document.getElementById('searchProduct').value = term;
            searchProducts();
        }

        function clearSearch() {
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchProduct').focus();
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            if (searchTerm.length < 1) { resultsDiv.innerHTML = ''; return; }

            const filtered = productList.filter(p => 
                (p.name && p.name.toLowerCase().includes(searchTerm)) || 
                (p.itemcode && p.itemcode.toLowerCase().includes(searchTerm))
            );
            
            let html = '';
            filtered.slice(0, 10).forEach(product => { // Limit results for performance
                const price = parseFloat(product[document.getElementById('patientType').value] || 0);
                html += `<div class="search-item" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="addItemToCart('${product.itemcode}')">
                            [${product.itemcode}] ${product.name} - <strong>${price.toFixed(2)}฿</strong>
                         </div>`;
            });
            resultsDiv.innerHTML = html;
        }

        function addItemToCart(itemCode) {
            const product = productList.find(p => p.itemcode === itemCode);
            if (!product) return;

            const existingItem = shoppingCart.find(item => item.itemcode === itemCode);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                const price = parseFloat(product[document.getElementById('patientType').value] || 0);
                shoppingCart.push({ ...product, price: price, quantity: 1 });
            }
            updateCartDisplay();
            
            // Clear search input and results for better UX after adding an item.
            clearSearch();
        }

        function updateCartDisplay() {
            const cartBody = document.getElementById('cartItems');
            cartBody.innerHTML = '';
            shoppingCart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                const row = cartBody.insertRow();
                row.innerHTML = `
                    <td>${item.name} <small>(${item.itemcode})</small></td>
                    <td>${item.price.toFixed(2)}</td>
                    <td><input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)" style="width: 60px;"></td>
                    <td>${itemTotal.toFixed(2)}</td>
                    <td><button onclick="removeFromCart(${index})" style="background-color:#e74c3c; padding: 5px 10px;">X</button></td>
                `;
            });

            const productTotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('cartTotal').textContent = productTotal.toFixed(2);
            updateBillingSummary();
        }
        
        function updateQuantity(index, newQuantity) {
            const qty = parseInt(newQuantity, 10);
            if(qty > 0) shoppingCart[index].quantity = qty;
            else shoppingCart.splice(index, 1);
            updateCartDisplay();
        }

        function removeFromCart(index) {
            shoppingCart.splice(index, 1);
            updateCartDisplay();
        }

        // --- RECEIPT & SAVING LOGIC (TAB 3) ---
        async function generateReceipt() {
             if (shoppingCart.length === 0) {
                if (!confirm("Cart is empty. Do you want to proceed without any products?")) {
                    return;
                }
            }
            await saveTransaction();
            populateReceiptForDisplay('TXN-' + Date.now());
            openTab('receiptTab');
        }

        async function saveTransaction() {
            const billing = updateBillingSummary();
            const transactionData = {
                id: 'TXN-' + Date.now(),
                fname: currentPatientDetails.firstName,
                lname: currentPatientDetails.lastName,
                date: new Date().toISOString(),
                type: currentPatientDetails.type,
                products: shoppingCart.map(item => `${item.name}(${item.quantity})`).join('; '),
                total: billing.productTotal,
                doctor_name: currentPatientDetails.doctorName,
                consultant: currentPatientDetails.consultant,
                hospital_fee: billing.hospitalFee,
                deposit_amount: billing.depositAmount,
                outstanding_balance: billing.outstandingBalance,
                payment_method: currentPatientDetails.paymentMethod,
                review_status: currentPatientDetails.reviewStatus,
                procedure_info: currentPatientDetails.procedureInfo,
                patient_age: currentPatientDetails.patientAge,
                comment: currentPatientDetails.comment // Add comment to transaction data
            };

            try {
                const response = await fetch('/save-log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
                if (!response.ok) throw new Error('Server responded with an error.');
                
                console.log('Transaction saved successfully.');
                await loadTransactionHistory(); // Refresh history after saving
            } catch (error) {
                console.error("Error saving transaction:", error);
                alert("Could not save transaction to server.");
            }
        }

        function populateReceiptForDisplay(transactionId, details = currentPatientDetails, cart = shoppingCart, transaction = null) {
            // Clones the hidden template to show it in the UI without affecting the print version
            const template = document.getElementById('receipt');
            const clone = template.cloneNode(true);
            clone.id = 'receipt_display'; // Give it a new ID to avoid conflicts
            clone.classList.remove('print-area'); // It's not the print area itself, just a view

            const receiptContainer = document.querySelector('#receiptTab .receipt-preview-container');
            receiptContainer.innerHTML = ''; // Clear previous receipt
            receiptContainer.appendChild(clone);
            
            // Now populate the cloned receipt
            populatePrintableData(clone.id, transactionId, details, cart, transaction);
        }


        // --- HISTORY LOGIC (TAB 4) ---
        async function loadTransactionHistory() {
            try {
                const response = await fetch('/static/log.csv?t=' + new Date().getTime()); // Prevent caching
                if (!response.ok) throw new Error('Failed to load history file.');
                const csvData = await response.text();
                if (csvData.trim() === '') {
                    transactionHistory = [];
                } else {
                    // Pass the ALL_HEADERS constant to ensure the header row is skipped
                    transactionHistory = parseCsv(csvData, true);
                }
                searchHistory(); // Display all history initially
            } catch (error) {
                console.error("Error loading transaction history:", error);
                document.getElementById('historyResults').innerHTML = '<p>Error loading transaction history.</p>';
            }
        }

        function searchHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const historyDiv = document.getElementById('historyResults');
            
            const filtered = transactionHistory.filter(txn => {
                const fullName = `${txn.fname || ''} ${txn.lname || ''}`.toLowerCase();
                const date = new Date(txn.date).toLocaleString('th-TH').toLowerCase();
                const doctor = (txn.doctor_name || '').toLowerCase();
                return fullName.includes(searchTerm) || date.includes(searchTerm) || doctor.includes(searchTerm);
            });
            
            if (filtered.length === 0) {
                historyDiv.innerHTML = '<p>No transactions found.</p>'; return;
            }
            
            historyDiv.innerHTML = filtered.reverse().map(txn => `
                <div onclick="viewReceiptFromHistory('${txn.id}')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer;">
                    <strong>${txn.fname || ''} ${txn.lname || ''}</strong> (${new Date(txn.date).toLocaleDateString('th-TH')})
                    <div style="float: right;">ค้างชำระ: <strong>${parseFloat(txn.outstanding_balance || 0).toFixed(2)}฿</strong></div>
                    <div style="font-size:0.9em; color: #555;">Doctor: ${txn.doctor_name || 'N/A'}</div>
                </div>`
            ).join('');
        }
        
        function viewReceiptFromHistory(txnId) {
             const txn = transactionHistory.find(t => t.id === txnId);
             if (!txn) { alert("Transaction not found!"); return; }

             // 1. Populate a temporary details object for receipt generation
             const detailsForReceipt = {
                firstName: txn.fname, lastName: txn.lname, type: txn.type, patientAge: txn.patient_age,
                doctorName: txn.doctor_name, consultant: txn.consultant, procedureInfo: txn.procedure_info,
                paymentMethod: txn.payment_method, reviewStatus: txn.review_status,
                comment: txn.comment 
             };
             
             // 2. Reconstruct a temporary shopping cart for receipt generation
             const cartForReceipt = (txn.products || '').split(';').map(p => {
                const match = p.trim().match(/(.+)\((\d+)\)/);
                if (!match) return null;
                const [_, name, quantity] = match;
                const product = productList.find(prod => prod.name === name.trim()) || {price:0, itemcode:'N/A'};
                return { ...product, quantity: parseInt(quantity, 10), price: parseFloat(product[txn.type] || 0) };
             }).filter(Boolean);
             
             // 3. Populate and show the receipt without changing the main form
             populateReceiptForDisplay(txn.id, detailsForReceipt, cartForReceipt, txn);
             
             // 4. Go directly to the Receipt tab for viewing
             openTab('receiptTab'); 
        }
        
        // --- PRINTING LOGIC ---
        function populatePrintableData(elementId, transactionId, details = currentPatientDetails, cart = shoppingCart, transaction = null) {
            const container = document.getElementById(elementId);
            
            // Use live billing summary if no specific transaction is passed, otherwise use historical data
            const billing = transaction ? {
                productTotal: parseFloat(transaction.total || 0),
                hospitalFee: parseFloat(transaction.hospital_fee || 0),
                grandTotal: parseFloat(transaction.total || 0) + parseFloat(transaction.hospital_fee || 0),
                depositAmount: parseFloat(transaction.deposit_amount || 0),
                outstandingBalance: parseFloat(transaction.outstanding_balance || 0),
            } : updateBillingSummary();

            const fields = {
                receiptId: transactionId,
                receiptDate: new Date(transaction ? transaction.date : Date.now()).toLocaleString('th-TH'),
                receiptName: `${details.firstName} ${details.lastName}`,
                receiptAge: details.patientAge || 'N/A',
                receiptType: details.type,
                receiptDoctor: details.doctorName || 'N/A',
                receiptConsultant: details.consultant || 'N/A',
                receiptProcedure: details.procedureInfo || 'N/A',
                receiptSubtotal: billing.productTotal.toFixed(2),
                receiptHospitalFee: billing.hospitalFee.toFixed(2),
                receiptGrandTotal: billing.grandTotal.toFixed(2),
                receiptDeposit: billing.depositAmount.toFixed(2),
                receiptOutstanding: billing.outstandingBalance.toFixed(2),
                receiptPaymentMethod: details.paymentMethod,
                receiptReviewStatus: details.reviewStatus,
                comment: details.comment || 'N/A'
            };

            for(const key in fields) {
                const element = container.querySelector(`[data-field="${key}"]`);
                if(element) element.textContent = fields[key];
            }
            
            const receiptItemsBody = container.querySelector('#receiptItemsTable_print tbody');
            receiptItemsBody.innerHTML = '';
            cart.forEach(item => {
                const row = receiptItemsBody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>${(item.price * item.quantity).toFixed(2)}</td>
                `;
            });
        }
        
        function printMainReceipt() {
            // Repopulate with current data before printing
            const transactionId = currentPatientDetails.id || 'TXN-' + Date.now();
            populatePrintableData('receipt', transactionId, currentPatientDetails, shoppingCart, null);
            document.body.classList.add('print-active');
            document.querySelectorAll('.main-container, h1.no-print').forEach(el => el.style.display = 'none');
            document.getElementById('receipt').style.display = 'block';
            window.print();
        }

        function printDepositSlip() {
            const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
            if (depositAmount <= 0) {
                alert("Please enter a valid deposit amount before printing.");
                return;
            }
            
            const fields = {
                depositDate: new Date().toLocaleString('th-TH'),
                depositName: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
                depositProcedure: document.getElementById('procedureInfo').value || 'N/A',
                depositAmount: depositAmount.toFixed(2)
            };

            for(const key in fields) {
                const element = document.querySelector(`#depositSlip [data-field="${key}"]`);
                if(element) element.textContent = fields[key];
            }
            
            document.body.classList.add('print-active');
            document.querySelectorAll('.main-container, h1.no-print').forEach(el => el.style.display = 'none');
            document.getElementById('depositSlip').style.display = 'block';
            
            window.print();
        }

        // Clean up after printing
        window.onafterprint = () => {
            document.body.classList.remove('print-active');
            document.querySelectorAll('.main-container, h1.no-print').forEach(el => el.style.display = '');
            document.getElementById('receipt').style.display = '';
            document.getElementById('depositSlip').style.display = '';
        };

        // --- UTILITY & RESET ---
        function parseCsv(csvData, hasHeader = true) {
            const lines = csvData.trim().split(/\r?\n/);
            if (lines.length < (hasHeader ? 2 : 1) ) return []; 

            const headerRow = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const startIndex = hasHeader ? 1 : 0;
            
            const dataRows = lines.slice(startIndex);
            if(dataRows.length === 0) return [];
            
            const csvRegex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;

            return dataRows.map(line => {
                if (!line.trim()) return null;

                const matches = [...line.matchAll(csvRegex)];
                const values = matches.map(m => {
                    let value = m[1]; 
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1).replace(/""/g, '"');
                    }
                    return value;
                });
                
                let obj = {};
                headerRow.forEach((header, index) => {
                    obj[header] = values[index] !== undefined ? values[index].trim() : '';
                });
                return obj;
            }).filter(Boolean); 
        }
        
        function resetFlow() {
            // Reset forms in Tab 1
            document.getElementById('patientTab').querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => input.value = '');
            document.getElementById('patientType').selectedIndex = 0;
            document.getElementById('payCash').checked = true;

            // Uncheck all review statuses
            document.querySelectorAll('input[name="reviewStatus"]').forEach(cb => cb.checked = false);

            document.getElementById('hospitalFee').value = 0;
            document.getElementById('depositAmount').value = 0;

            // Reset cart and products
            shoppingCart = [];
            currentPatientDetails = {};
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchResults').innerHTML = '';
            
            updateCartDisplay(); // This will also update the summary
            openTab('patientTab');
            document.getElementById('firstName').focus();
        }

    </script>
</body>
</html>
